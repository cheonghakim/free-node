!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).FreeNode={})}(this,function(t){"use strict";class e{constructor(){this.types=new Map}register(t,e){if(this.types.has(t))throw new Error(`Node type exists: ${t}`);this.types.set(t,e)}createInstance(t){const e=this.types.get(t);if(!e)throw new Error(`Unknown node type: ${t}`);return e}}function s(){if("undefined"!=typeof crypto&&crypto.randomUUID)return crypto.randomUUID();const t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128;const e=Array.from(t).map(t=>t.toString(16).padStart(2,"0"));return e.slice(0,4).join("")+"-"+e.slice(4,6).join("")+"-"+e.slice(6,8).join("")+"-"+e.slice(8,10).join("")+"-"+e.slice(10).join("")}class o{constructor({id:t,type:e,title:o,x:i=0,y:n=0,width:r=160,height:h=60}){this.id=t??s(),this.type=e,this.title=o??e,this.pos={x:i,y:n},this.size={width:r,height:h},this.inputs=[],this.outputs=[],this.state={}}addInput(t,e="any"){const o={id:s(),name:t,datatype:e,dir:"in"};return this.inputs.push(o),o}addOutput(t,e="any"){const o={id:s(),name:t,datatype:e,dir:"out"};return this.outputs.push(o),o}}class i{constructor({id:t,fromNode:e,fromPort:o,toNode:i,toPort:n}){this.id=t??s(),this.fromNode=e,this.fromPort=o,this.toNode=i,this.toPort=n}}class n{constructor({hooks:t,registry:e}){this.nodes=new Map,this.edges=new Map,this.hooks=t,this.registry=e,this._valuesA=new Map,this._valuesB=new Map,this._useAasCurrent=!0}addNode(t,e={}){var s,i,n,r;const h=this.registry.types.get(t);if(!h)throw new Error(`Unknown node type: ${t}`);const d=new o({type:t,title:h.title,width:null==(s=h.size)?void 0:s.w,height:null==(i=h.size)?void 0:i.h,...e});for(const o of h.inputs||[])d.addInput(o.name,o.datatype);for(const o of h.outputs||[])d.addOutput(o.name,o.datatype);return null==(n=h.onCreate)||n.call(h,d),this.nodes.set(d.id,d),null==(r=this.hooks)||r.emit("node:create",d),d}removeNode(t){for(const[e,s]of this.edges)s.fromNode!==t&&s.toNode!==t||this.edges.delete(e);this.nodes.delete(t)}addEdge(t,e,s,o){var n;const r=new i({fromNode:t,fromPort:e,toNode:s,toPort:o});return this.edges.set(r.id,r),null==(n=this.hooks)||n.emit("edge:create",r),r}_curBuf(){return this._useAasCurrent?this._valuesA:this._valuesB}_nextBuf(){return this._useAasCurrent?this._valuesB:this._valuesA}swapBuffers(){this._useAasCurrent=!this._useAasCurrent,this._nextBuf().clear()}setOutput(t,e,s){this._nextBuf().set(`${t}:${e}`,s)}getInput(t,e){for(const s of this.edges.values())if(s.toNode===t&&s.toPort===e)return this._curBuf().get(`${s.fromNode}:${s.fromPort}`)}toJSON(){var t;const e={nodes:[...this.nodes.values()].map(t=>({id:t.id,type:t.type,title:t.title,x:t.pos.x,y:t.pos.y,w:t.size.width,h:t.size.height,inputs:t.inputs,outputs:t.outputs,state:t.state})),edges:[...this.edges.values()]};return null==(t=this.hooks)||t.emit("graph:serialize",e),e}static fromJSON(t,{hooks:e,registry:s}){const r=new n({hooks:e,registry:s});for(const i of t.nodes){const t=new o({id:i.id,type:i.type,title:i.title,x:i.x,y:i.y,width:i.w,height:i.h});t.inputs=i.inputs,t.outputs=i.outputs,t.state=i.state||{},r.nodes.set(t.id,t)}for(const o of t.edges)r.edges.set(o.id,new i(o));return r}}function r(t,e,s){const{x:o,y:i}=t.pos,{width:n,height:r}=t.size;return e>=o&&e<=o+n&&s>=i&&s<=i+r}function h(t,e,s,o){const i=t.pos.y+28+20*s;return"in"===o?{x:t.pos.x-8,y:i,w:8,h:14}:"out"===o?{x:t.pos.x+t.size.width,y:i,w:8,h:14}:void 0}class d{constructor(t,{theme:e={},registry:s,edgeStyle:o="orthogonal"}={}){this.canvas=t,this.ctx=t.getContext("2d"),this.registry=s,this.scale=1,this.minScale=.25,this.maxScale=3,this.offsetX=0,this.offsetY=0,this.edgeStyle=o,this.theme=Object.assign({bg:"#141417",grid:"#25252a",node:"#1e1e24",title:"#2a2a31",text:"#e9e9ef",port:"#8aa1ff",edge:"#7f8cff"},e)}setEdgeStyle(t){this.edgeStyle="line"===t||"orthogonal"===t?t:"bezier"}setRegistry(t){this.registry=t}resize(t,e){this.canvas.width=t,this.canvas.height=e}setTransform({scale:t=this.scale,offsetX:e=this.offsetX,offsetY:s=this.offsetY}={}){this.scale=Math.min(this.maxScale,Math.max(this.minScale,t)),this.offsetX=e,this.offsetY=s}panBy(t,e){this.offsetX+=t,this.offsetY+=e}zoomAt(t,e,s){const o=this.scale,i=Math.min(this.maxScale,Math.max(this.minScale,o*t));if(i===o)return;const n=(e-this.offsetX)/o,r=(s-this.offsetY)/o;this.offsetX=e-n*i,this.offsetY=s-r*i,this.scale=i}_drawArrowhead(t,e,s,o,i=10){const{ctx:n}=this,r=i/this.scale,h=Math.atan2(o-e,s-t);n.beginPath(),n.moveTo(s,o),n.lineTo(s-r*Math.cos(h-Math.PI/6),o-r*Math.sin(h-Math.PI/6)),n.lineTo(s-r*Math.cos(h+Math.PI/6),o-r*Math.sin(h+Math.PI/6)),n.closePath(),n.fill()}screenToWorld(t,e){return{x:(t-this.offsetX)/this.scale,y:(e-this.offsetY)/this.scale}}worldToScreen(t,e){return{x:t*this.scale+this.offsetX,y:e*this.scale+this.offsetY}}_applyTransform(){const{ctx:t}=this;t.setTransform(this.scale,0,0,this.scale,this.offsetX,this.offsetY)}_resetTransform(){this.ctx.setTransform(1,0,0,1,0,0)}drawGrid(){const{ctx:t,canvas:e,theme:s,scale:o,offsetX:i,offsetY:n}=this;this._resetTransform(),t.fillStyle=s.bg,t.fillRect(0,0,e.width,e.height),this._applyTransform(),t.strokeStyle=s.grid,t.lineWidth=1/o;const r=20,h=-i/o,d=-n/o,a=(e.width-i)/o,l=(e.height-n)/o,c=Math.floor(h/r)*r,u=Math.floor(d/r)*r;t.beginPath();for(let f=c;f<=a;f+=r)t.moveTo(f,d),t.lineTo(f,l);for(let f=u;f<=l;f+=r)t.moveTo(h,f),t.lineTo(a,f);t.stroke(),this._resetTransform()}draw(t,{selection:e=new Set,tempEdge:s=null}={}){var o,i;this.drawGrid(),console.log(s);const{ctx:n,theme:r}=this;this._applyTransform(),n.strokeStyle=r.edge,n.lineWidth=2/this.scale;for(const h of t.edges.values())this._drawEdge(t,h);if(s){const t=this.screenToWorld(s.x1,s.y1),e=this.screenToWorld(s.x2,s.y2),o=this.ctx.getLineDash();this.ctx.setLineDash([6/this.scale,6/this.scale]);let i=null;if("line"===this.edgeStyle?(this._drawLine(t.x,t.y,e.x,e.y),i=[{x:t.x,y:t.y},{x:e.x,y:e.y}]):"orthogonal"===this.edgeStyle?i=this._drawOrthogonal(t.x,t.y,e.x,e.y):(this._drawCurve(t.x,t.y,e.x,e.y),i=[{x:t.x,y:t.y},{x:e.x,y:e.y}]),this.ctx.setLineDash(o),i&&i.length>=2){const t=i[i.length-2],e=i[i.length-1];this.ctx.fillStyle=this.theme.edge,this.ctx.strokeStyle=this.theme.edge,this._drawArrowhead(t.x,t.y,e.x,e.y,12)}}for(const h of t.nodes.values()){const t=e.has(h.id);this._drawNode(h,t);const s=null==(i=null==(o=this.registry)?void 0:o.types)?void 0:i.get(h.type);(null==s?void 0:s.onDraw)&&s.onDraw(h,{ctx:n,theme:r})}this._resetTransform()}_drawNode(t,e){const{ctx:s,theme:o}=this,{x:i,y:n}=t.pos,{width:r,height:d}=t.size;s.fillStyle=o.node,s.strokeStyle=e?"#6cf":"#333",s.lineWidth=(e?2:1.2)/this.scale,a(s,i,n,r,d,8),s.fill(),s.stroke(),s.fillStyle=o.title,a(s,i,n,r,24,{tl:8,tr:8,br:0,bl:0}),s.fill(),s.fillStyle=o.text,s.font=12/this.scale+"px system-ui",s.fillText(t.title,i+8,n+16),s.fillStyle=o.port,t.inputs.forEach((e,o)=>{const i=h(t,0,o,"in");s.fillRect(i.x,i.y,i.w,i.h)}),t.outputs.forEach((e,o)=>{const i=h(t,0,o,"out");s.fillRect(i.x,i.y,i.w,i.h)})}_drawEdge(t,e){const s=t.nodes.get(e.fromNode),o=t.nodes.get(e.toNode);if(!s||!o)return;const i=s.outputs.findIndex(t=>t.id===e.fromPort),n=o.inputs.findIndex(t=>t.id===e.toPort),r=h(s,0,i,"out"),d=h(o,0,n,"in"),a=r.x,l=r.y+7,c=d.x,u=d.y+7;"line"===this.edgeStyle?this._drawLine(a,l,c,u):"orthogonal"===this.edgeStyle?this._drawOrthogonal(a,l,c,u):this._drawCurve(a,l,c,u)}_drawLine(t,e,s,o){const{ctx:i}=this;i.beginPath(),i.moveTo(t,e),i.lineTo(s,o),i.stroke()}_drawPolyline(t){const{ctx:e}=this;e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)e.lineTo(t[s].x,t[s].y);e.stroke()}_drawOrthogonal(t,e,s,o){const i=(t+s)/2;let n;n=[{x:t,y:e},{x:i,y:e},{x:i,y:o},{x:s,y:o}];const{ctx:r}=this,h=r.lineJoin,d=r.lineCap;return r.lineJoin="round",r.lineCap="round",this._drawPolyline(n),r.lineJoin=h,r.lineCap=d,n}_drawCurve(t,e,s,o){const{ctx:i}=this,n=Math.max(40,.4*Math.abs(s-t));i.beginPath(),i.moveTo(t,e),i.bezierCurveTo(t+n,e,s-n,o,s,o),i.stroke()}}function a(t,e,s,o,i,n=6){"number"==typeof n&&(n={tl:n,tr:n,br:n,bl:n}),t.beginPath(),t.moveTo(e+n.tl,s),t.lineTo(e+o-n.tr,s),t.quadraticCurveTo(e+o,s,e+o,s+n.tr),t.lineTo(e+o,s+i-n.br),t.quadraticCurveTo(e+o,s+i,e+o-n.br,s+i),t.lineTo(e+n.bl,s+i),t.quadraticCurveTo(e,s+i,e,s+i-n.bl),t.lineTo(e,s+n.tl),t.quadraticCurveTo(e,s,e+n.tl,s),t.closePath()}class l{constructor({graph:t,renderer:e,hooks:s}){this.graph=t,this.renderer=e,this.hooks=s,this.selection=new Set,this.dragging=null,this.connecting=null,this.panning=null,this._cursor="default",this._bindEvents()}_bindEvents(){const t=this.renderer.canvas;t.addEventListener("mousedown",t=>this._onDown(t)),window.addEventListener("mousemove",t=>this._onMove(t)),window.addEventListener("mouseup",t=>this._onUp(t)),t.addEventListener("wheel",t=>this._onWheel(t),{passive:!1})}_setCursor(t){this._cursor!==t&&(this._cursor=t,this.renderer.canvas.style.cursor=t)}_posScreen(t){const e=this.renderer.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}_posWorld(t){const e=this._posScreen(t);return this.renderer.screenToWorld(e.x,e.y)}_findNodeAtWorld(t,e){const s=[...this.graph.nodes.values()];for(let o=s.length-1;o>=0;o--){const i=s[o];if(r(i,t,e))return i}return null}_findPortAtWorld(t,e){for(const s of this.graph.nodes.values()){for(let o=0;o<s.inputs.length;o++){if(c(h(s,s.inputs[o],o,"in"),t,e))return{node:s,port:s.inputs[o],dir:"in",idx:o}}for(let o=0;o<s.outputs.length;o++){if(c(h(s,s.outputs[o],o,"out"),t,e))return{node:s,port:s.outputs[o],dir:"out",idx:o}}}return null}_onWheel(t){t.preventDefault();const{x:e,y:s}=this._posScreen(t),o=Math.pow(1.0015,-t.deltaY);this.renderer.zoomAt(o,e,s),this.render()}_findIncomingEdge(t,e){for(const[s,o]of this.graph.edges)if(o.toNode===t&&o.toPort===e)return{id:s,edge:o};return null}_onDown(t){const e=this._posScreen(t),s=this._posWorld(t);if(1===t.button)return void(this.panning={x:e.x,y:e.y});const o=this._findPortAtWorld(s.x,s.y);if(0===t.button&&o&&"out"===o.dir){const t=h(o.node,o.port,o.idx,"out"),e=this.renderer.worldToScreen(t.x,t.y+7);return void(this.connecting={fromNode:o.node.id,fromPort:o.port.id,x:e.x,y:e.y})}if(0===t.button&&o&&"in"===o.dir){const t=this._findIncomingEdge(o.node.id,o.port.id);if(t){const{edge:e,id:s}=t;this.graph.edges.delete(s);const o=h(this.graph.nodes.get(e.fromNode),this.graph.nodes.get(e.fromNode).outputs.find(t=>t.id===e.fromPort),this.graph.nodes.get(e.fromNode).outputs.findIndex(t=>t.id===e.fromPort),"out"),i=this.renderer.worldToScreen(o.x,o.y+7);return this.connecting={fromNode:e.fromNode,fromPort:e.fromPort,x:i.x,y:i.y,_rewireFromEdgeId:s},void this.render()}}const i=this._findNodeAtWorld(s.x,s.y);return 0===t.button&&i?(t.shiftKey||this.selection.clear(),this.selection.add(i.id),this.dragging={nodeId:i.id,dx:s.x-i.pos.x,dy:s.y-i.pos.y},void this.render()):0===t.button?(this.selection.size&&this.selection.clear(),this.panning={x:e.x,y:e.y},void this.render()):void 0}_onMove(t){var e;const s=this._posScreen(t),o=this.renderer.screenToWorld(s.x,s.y);if(this.panning){const t=s.x-this.panning.x,e=s.y-this.panning.y;return this.panning={x:s.x,y:s.y},this.renderer.panBy(t,e),void this.render()}if(this.dragging){const t=this.graph.nodes.get(this.dragging.nodeId);return t.pos.x=o.x-this.dragging.dx,t.pos.y=o.y-this.dragging.dy,null==(e=this.hooks)||e.emit("node:move",t),void this.render()}this.connecting&&(this.connecting.x=s.x,this.connecting.y=s.y,this.render());const i=this._findPortAtWorld(o.x,o.y);!i||"out"!==i.dir&&"in"!==i.dir?this._setCursor("default"):this._setCursor("grabbing")}_onUp(t){this._posScreen(t);const e=this._posWorld(t);if(this.panning)this.panning=null;else{if(this.connecting){const t=this.connecting,s=this._findPortAtWorld(e.x,e.y);s&&"in"===s.dir&&this.graph.addEdge(t.fromNode,t.fromPort,s.node.id,s.port.id),this.connecting=null,this.render()}this.dragging=null}}render(){const t=this.connecting?(()=>{const t=this._portAnchorScreen(this.connecting.fromNode,this.connecting.fromPort),e={x:this.connecting.x,y:this.connecting.y};return{x1:t.x,y1:t.y,x2:e.x,y2:e.y}})():null;this.renderer.draw(this.graph,{selection:this.selection,tempEdge:t})}_portAnchorScreen(t,e){const s=this.graph.nodes.get(t),o=s.outputs.findIndex(t=>t.id===e),i=h(s,0,o,"out");return this.renderer.worldToScreen(i.x,i.y+7)}}function c(t,e,s){return e>=t.x&&e<=t.x+t.w&&s>=t.y&&s<=t.y+t.h}class u{constructor({graph:t,registry:e,hooks:s,cyclesPerFrame:o=1}){this.graph=t,this.registry=e,this.hooks=s,this.running=!1,this._raf=null,this._last=0,this.cyclesPerFrame=Math.max(1,0|o)}step(t=1,e=0){var s;const o=Math.max(1,0|t);for(let n=0;n<o;n++){for(const t of this.graph.nodes.values()){const o=this.registry.types.get(t.type);if(null==o?void 0:o.onExecute)try{o.onExecute(t,{dt:e,graph:this.graph,getInput:e=>{const s=t.inputs.find(t=>t.name===e)||t.inputs[0];return s?this.graph.getInput(t.id,s.id):void 0},setOutput:(e,s)=>{const o=t.outputs.find(t=>t.name===e)||t.outputs[0];o&&this.graph.setOutput(t.id,o.id,s)}})}catch(i){null==(s=this.hooks)||s.emit("error",i)}}this.graph.swapBuffers()}}start(){if(this.running)return;this.running=!0;const t=e=>{if(!this.running)return;const s=this._last?(e-this._last)/1e3:0;this._last=e,this.step(this.cyclesPerFrame,s),this._raf=requestAnimationFrame(t)};this._raf=requestAnimationFrame(t)}stop(){this.running=!1,this._raf&&cancelAnimationFrame(this._raf),this._raf=null,this._last=0}}t.createGraphEditor=function(t,{theme:s,hooks:o,autorun:i=!0}={}){const r=o??function(t){const e=Object.fromEntries(t.map(t=>[t,new Set]));return{on:(t,s)=>(e[t].add(s),()=>e[t].delete(s)),async emit(t,...s){for(const o of e[t])await o(...s)}}}(["node:create","node:move","edge:create","edge:delete","graph:serialize","error"]),h=new e,a=new n({hooks:r,registry:h}),c=new d(t,{theme:s,registry:h}),f=new l({graph:a,renderer:c,hooks:r}),g=new u({graph:a,registry:h,hooks:r});h.register("core/Note",{title:"Note",size:{w:180,h:80},inputs:[{name:"in",datatype:"any"}],outputs:[{name:"out",datatype:"any"}],onCreate(t){t.state.text="hello"},onExecute(t,{dt:e,getInput:s,setOutput:o}){o("out",(s("in")??t.state.text??"").toString().toUpperCase()+` · ${Math.floor(performance.now()/1e3%100)}`)},onDraw(t,{ctx:e,theme:s}){const{x:o,y:i}=t.pos,{width:n}=t.size;e.fillStyle=s.text,e.font="11px system-ui",e.fillText(t.state.text??"hello",o+8,i+40)}}),c.resize(t.clientWidth,t.clientHeight),f.render();const p=new ResizeObserver(()=>{c.resize(t.clientWidth,t.clientHeight),f.render()});p.observe(t);const y={graph:a,renderer:c,controller:f,hooks:r,registry:h,runner:g,addNode:(...t)=>a.addNode(...t),toJSON:()=>a.toJSON(),fromJSON:t=>n.fromJSON(t,{hooks:r,registry:h}),resize:(t,e)=>c.resize(t,e),render:()=>f.render(),start:()=>g.start(),stop:()=>g.stop(),destroy:()=>{g.stop(),p.disconnect()}};return i&&g.start(),y},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=free-node.umd.js.map
