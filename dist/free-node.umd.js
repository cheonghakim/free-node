!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).FreeNode={})}(this,function(t){"use strict";class e{constructor(){this.types=new Map}register(t,e){if(this.types.has(t))throw new Error(`Node type exists: ${t}`);this.types.set(t,e)}createInstance(t){const e=this.types.get(t);if(!e)throw new Error(`Unknown node type: ${t}`);return e}}function s(){if("undefined"!=typeof crypto&&crypto.randomUUID)return crypto.randomUUID();const t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128;const e=Array.from(t).map(t=>t.toString(16).padStart(2,"0"));return e.slice(0,4).join("")+"-"+e.slice(4,6).join("")+"-"+e.slice(6,8).join("")+"-"+e.slice(8,10).join("")+"-"+e.slice(10).join("")}class i{constructor({id:t,type:e,title:i,x:o=0,y:n=0,width:r=160,height:h=60}){this.id=t??s(),this.type=e,this.title=i??e,this.pos={x:o,y:n},this.size={width:r,height:h},this.inputs=[],this.outputs=[],this.state={}}addInput(t,e="any"){const i={id:s(),name:t,datatype:e,dir:"in"};return this.inputs.push(i),i}addOutput(t,e="any"){const i={id:s(),name:t,datatype:e,dir:"out"};return this.outputs.push(i),i}}class o{constructor({id:t,fromNode:e,fromPort:i,toNode:o,toPort:n}){this.id=t??s(),this.fromNode=e,this.fromPort=i,this.toNode=o,this.toPort=n}}class n{constructor({hooks:t,registry:e}){this.nodes=new Map,this.edges=new Map,this.hooks=t,this.registry=e,this._valuesA=new Map,this._valuesB=new Map,this._useAasCurrent=!0}addNode(t,e={}){var s,o,n,r;const h=this.registry.types.get(t);if(!h)throw new Error(`Unknown node type: ${t}`);const d=new i({type:t,title:h.title,width:null==(s=h.size)?void 0:s.w,height:null==(o=h.size)?void 0:o.h,...e});for(const i of h.inputs||[])d.addInput(i.name,i.datatype);for(const i of h.outputs||[])d.addOutput(i.name,i.datatype);return null==(n=h.onCreate)||n.call(h,d),this.nodes.set(d.id,d),null==(r=this.hooks)||r.emit("node:create",d),d}removeNode(t){for(const[e,s]of this.edges)s.fromNode!==t&&s.toNode!==t||this.edges.delete(e);this.nodes.delete(t)}addEdge(t,e,s,i){var n;const r=new o({fromNode:t,fromPort:e,toNode:s,toPort:i});return this.edges.set(r.id,r),null==(n=this.hooks)||n.emit("edge:create",r),r}clear(){var t,e;null==(t=this.nodes)||t.clear(),null==(e=this.edges)||e.clear(),this.nodes=new Map,this.edges=new Map}_curBuf(){return this._useAasCurrent?this._valuesA:this._valuesB}_nextBuf(){return this._useAasCurrent?this._valuesB:this._valuesA}swapBuffers(){this._useAasCurrent=!this._useAasCurrent,this._nextBuf().clear()}setOutput(t,e,s){this._nextBuf().set(`${t}:${e}`,s)}getInput(t,e){for(const s of this.edges.values())if(s.toNode===t&&s.toPort===e)return this._curBuf().get(`${s.fromNode}:${s.fromPort}`)}toJSON(){var t;const e={nodes:[...this.nodes.values()].map(t=>({id:t.id,type:t.type,title:t.title,x:t.pos.x,y:t.pos.y,w:t.size.width,h:t.size.height,inputs:t.inputs,outputs:t.outputs,state:t.state})),edges:[...this.edges.values()]};return null==(t=this.hooks)||t.emit("graph:serialize",e),e}static fromJSON(t,{hooks:e,registry:s}){const r=new n({hooks:e,registry:s});for(const o of t.nodes){const t=new i({id:o.id,type:o.type,title:o.title,x:o.x,y:o.y,width:o.w,height:o.h});t.inputs=o.inputs,t.outputs=o.outputs,t.state=o.state||{},r.nodes.set(t.id,t)}for(const i of t.edges)r.edges.set(i.id,new o(i));return r}}function r(t,e,s){const{x:i,y:o}=t.pos,{width:n,height:r}=t.size;return e>=i&&e<=i+n&&s>=o&&s<=o+r}function h(t,e,s,i){const o=t.pos.y+28+20*s;return"in"===i?{x:t.pos.x-8,y:o,w:8,h:14}:"out"===i?{x:t.pos.x+t.size.width,y:o,w:8,h:14}:void 0}class d{constructor(t,{theme:e={},registry:s,edgeStyle:i="orthogonal"}={}){this.canvas=t,this.ctx=t.getContext("2d"),this.registry=s,this.scale=1,this.minScale=.25,this.maxScale=3,this.offsetX=0,this.offsetY=0,this.edgeStyle=i,this.theme=Object.assign({bg:"#141417",grid:"#25252a",node:"#1e1e24",title:"#2a2a31",text:"#e9e9ef",port:"#8aa1ff",edge:"#7f8cff"},e)}setEdgeStyle(t){this.edgeStyle="line"===t||"orthogonal"===t?t:"bezier"}setRegistry(t){this.registry=t}resize(t,e){this.canvas.width=t,this.canvas.height=e}setTransform({scale:t=this.scale,offsetX:e=this.offsetX,offsetY:s=this.offsetY}={}){this.scale=Math.min(this.maxScale,Math.max(this.minScale,t)),this.offsetX=e,this.offsetY=s}panBy(t,e){this.offsetX+=t,this.offsetY+=e}zoomAt(t,e,s){const i=this.scale,o=Math.min(this.maxScale,Math.max(this.minScale,i*t));if(o===i)return;const n=(e-this.offsetX)/i,r=(s-this.offsetY)/i;this.offsetX=e-n*o,this.offsetY=s-r*o,this.scale=o}_drawArrowhead(t,e,s,i,o=10){const{ctx:n}=this,r=o/this.scale,h=Math.atan2(i-e,s-t);n.beginPath(),n.moveTo(s,i),n.lineTo(s-r*Math.cos(h-Math.PI/6),i-r*Math.sin(h-Math.PI/6)),n.lineTo(s-r*Math.cos(h+Math.PI/6),i-r*Math.sin(h+Math.PI/6)),n.closePath(),n.fill()}screenToWorld(t,e){return{x:(t-this.offsetX)/this.scale,y:(e-this.offsetY)/this.scale}}worldToScreen(t,e){return{x:t*this.scale+this.offsetX,y:e*this.scale+this.offsetY}}_applyTransform(){const{ctx:t}=this;t.setTransform(this.scale,0,0,this.scale,this.offsetX,this.offsetY)}_resetTransform(){this.ctx.setTransform(1,0,0,1,0,0)}drawGrid(){const{ctx:t,canvas:e,theme:s,scale:i,offsetX:o,offsetY:n}=this;this._resetTransform(),t.fillStyle=s.bg,t.fillRect(0,0,e.width,e.height),this._applyTransform(),t.strokeStyle=s.grid,t.lineWidth=1/i;const r=20,h=-o/i,d=-n/i,a=(e.width-o)/i,l=(e.height-n)/i,c=Math.floor(h/r)*r,u=Math.floor(d/r)*r;t.beginPath();for(let f=c;f<=a;f+=r)t.moveTo(f,d),t.lineTo(f,l);for(let f=u;f<=l;f+=r)t.moveTo(h,f),t.lineTo(a,f);t.stroke(),this._resetTransform()}draw(t,{selection:e=new Set,tempEdge:s=null}={}){var i,o;this.drawGrid(),console.log(s);const{ctx:n,theme:r}=this;this._applyTransform(),n.save(),n.strokeStyle=r.edge,n.lineWidth=2/this.scale;for(const h of t.edges.values())this._drawEdge(t,h);if(s){const t=this.screenToWorld(s.x1,s.y1),e=this.screenToWorld(s.x2,s.y2),i=this.ctx.getLineDash();this.ctx.setLineDash([6/this.scale,6/this.scale]);let o=null;if("line"===this.edgeStyle?(this._drawLine(t.x,t.y,e.x,e.y),o=[{x:t.x,y:t.y},{x:e.x,y:e.y}]):"orthogonal"===this.edgeStyle?o=this._drawOrthogonal(t.x,t.y,e.x,e.y):(this._drawCurve(t.x,t.y,e.x,e.y),o=[{x:t.x,y:t.y},{x:e.x,y:e.y}]),this.ctx.setLineDash(i),o&&o.length>=2){const t=o[o.length-2],e=o[o.length-1];this.ctx.fillStyle=this.theme.edge,this.ctx.strokeStyle=this.theme.edge,this._drawArrowhead(t.x,t.y,e.x,e.y,12)}}for(const h of t.nodes.values()){const t=e.has(h.id);this._drawNode(h,t);const s=null==(o=null==(i=this.registry)?void 0:i.types)?void 0:o.get(h.type);(null==s?void 0:s.onDraw)&&s.onDraw(h,{ctx:n,theme:r})}n.restore(),this._resetTransform()}_drawNode(t,e){const{ctx:s,theme:i}=this,{x:o,y:n}=t.pos,{width:r,height:d}=t.size;s.fillStyle=i.node,s.strokeStyle=e?"#6cf":"#333",s.lineWidth=(e?2:1.2)/this.scale,a(s,o,n,r,d,8),s.fill(),s.stroke(),s.fillStyle=i.title,a(s,o,n,r,24,{tl:8,tr:8,br:0,bl:0}),s.fill(),s.fillStyle=i.text,s.font=12/this.scale+"px system-ui",s.fillText(t.title,o+8,n+16),s.fillStyle=i.port,t.inputs.forEach((e,i)=>{const o=h(t,0,i,"in");s.fillRect(o.x,o.y,o.w,o.h)}),t.outputs.forEach((e,i)=>{const o=h(t,0,i,"out");s.fillRect(o.x,o.y,o.w,o.h)})}_drawEdge(t,e){const s=t.nodes.get(e.fromNode),i=t.nodes.get(e.toNode);if(!s||!i)return;const o=s.outputs.findIndex(t=>t.id===e.fromPort),n=i.inputs.findIndex(t=>t.id===e.toPort),r=h(s,0,o,"out"),d=h(i,0,n,"in"),a=r.x,l=r.y+7,c=d.x,u=d.y+7;"line"===this.edgeStyle?this._drawLine(a,l,c,u):"orthogonal"===this.edgeStyle?this._drawOrthogonal(a,l,c,u):this._drawCurve(a,l,c,u)}_drawLine(t,e,s,i){const{ctx:o}=this;o.beginPath(),o.moveTo(t,e),o.lineTo(s,i),o.stroke()}_drawPolyline(t){const{ctx:e}=this;e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)e.lineTo(t[s].x,t[s].y);e.stroke()}_drawOrthogonal(t,e,s,i){const o=(t+s)/2;let n;n=[{x:t,y:e},{x:o,y:e},{x:o,y:i},{x:s,y:i}];const{ctx:r}=this,h=r.lineJoin,d=r.lineCap;return r.lineJoin="round",r.lineCap="round",this._drawPolyline(n),r.lineJoin=h,r.lineCap=d,n}_drawCurve(t,e,s,i){const{ctx:o}=this,n=Math.max(40,.4*Math.abs(s-t));o.beginPath(),o.moveTo(t,e),o.bezierCurveTo(t+n,e,s-n,i,s,i),o.stroke()}}function a(t,e,s,i,o,n=6){"number"==typeof n&&(n={tl:n,tr:n,br:n,bl:n}),t.beginPath(),t.moveTo(e+n.tl,s),t.lineTo(e+i-n.tr,s),t.quadraticCurveTo(e+i,s,e+i,s+n.tr),t.lineTo(e+i,s+o-n.br),t.quadraticCurveTo(e+i,s+o,e+i-n.br,s+o),t.lineTo(e+n.bl,s+o),t.quadraticCurveTo(e,s+o,e,s+o-n.bl),t.lineTo(e,s+n.tl),t.quadraticCurveTo(e,s,e+n.tl,s),t.closePath()}class l{constructor({graph:t,renderer:e,hooks:s}){this.graph=t,this.renderer=e,this.hooks=s,this.selection=new Set,this.dragging=null,this.connecting=null,this.panning=null,this._onKeyPressEvt=this._onKeyPress.bind(this),this._onDownEvt=this._onDown.bind(this),this._onWheelEvt=this._onWheel.bind(this),this._onMoveEvt=this._onMove.bind(this),this._onUpEvt=this._onUp.bind(this),this._cursor="default",this._bindEvents()}_bindEvents(){const t=this.renderer.canvas;t.addEventListener("mousedown",this._onDownEvt),t.addEventListener("wheel",this._onWheelEvt,{passive:!1}),window.addEventListener("mousemove",this._onMoveEvt),window.addEventListener("mouseup",this._onUpEvt),window.addEventListener("keydown",this._onKeyPressEvt)}_onKeyPress(t){"Delete"===t.key&&([...this.selection].forEach(t=>{this.graph.removeNode(t)}),this.render())}_setCursor(t){this._cursor!==t&&(this._cursor=t,this.renderer.canvas.style.cursor=t)}_posScreen(t){const e=this.renderer.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}_posWorld(t){const e=this._posScreen(t);return this.renderer.screenToWorld(e.x,e.y)}_findNodeAtWorld(t,e){const s=[...this.graph.nodes.values()];for(let i=s.length-1;i>=0;i--){const o=s[i];if(r(o,t,e))return o}return null}_findPortAtWorld(t,e){for(const s of this.graph.nodes.values()){for(let i=0;i<s.inputs.length;i++){if(c(h(s,s.inputs[i],i,"in"),t,e))return{node:s,port:s.inputs[i],dir:"in",idx:i}}for(let i=0;i<s.outputs.length;i++){if(c(h(s,s.outputs[i],i,"out"),t,e))return{node:s,port:s.outputs[i],dir:"out",idx:i}}}return null}_onWheel(t){t.preventDefault();const{x:e,y:s}=this._posScreen(t),i=Math.pow(1.0015,-t.deltaY);this.renderer.zoomAt(i,e,s),this.render()}_findIncomingEdge(t,e){for(const[s,i]of this.graph.edges)if(i.toNode===t&&i.toPort===e)return{id:s,edge:i};return null}_onDown(t){const e=this._posScreen(t),s=this._posWorld(t);if(1===t.button)return void(this.panning={x:e.x,y:e.y});const i=this._findPortAtWorld(s.x,s.y);if(0===t.button&&i&&"out"===i.dir){const t=h(i.node,i.port,i.idx,"out"),e=this.renderer.worldToScreen(t.x,t.y+7);return void(this.connecting={fromNode:i.node.id,fromPort:i.port.id,x:e.x,y:e.y})}if(0===t.button&&i&&"in"===i.dir){const t=this._findIncomingEdge(i.node.id,i.port.id);if(t){const{edge:e,id:s}=t;this.graph.edges.delete(s);const i=h(this.graph.nodes.get(e.fromNode),this.graph.nodes.get(e.fromNode).outputs.find(t=>t.id===e.fromPort),this.graph.nodes.get(e.fromNode).outputs.findIndex(t=>t.id===e.fromPort),"out"),o=this.renderer.worldToScreen(i.x,i.y+7);return this.connecting={fromNode:e.fromNode,fromPort:e.fromPort,x:o.x,y:o.y,_rewireFromEdgeId:s},void this.render()}}const o=this._findNodeAtWorld(s.x,s.y);return 0===t.button&&o?(t.shiftKey||this.selection.clear(),this.selection.add(o.id),this.dragging={nodeId:o.id,dx:s.x-o.pos.x,dy:s.y-o.pos.y},void this.render()):0===t.button?(this.selection.size&&this.selection.clear(),this.panning={x:e.x,y:e.y},void this.render()):void 0}_onMove(t){var e;const s=this._posScreen(t),i=this.renderer.screenToWorld(s.x,s.y);if(this.panning){const t=s.x-this.panning.x,e=s.y-this.panning.y;return this.panning={x:s.x,y:s.y},this.renderer.panBy(t,e),void this.render()}if(this.dragging){const t=this.graph.nodes.get(this.dragging.nodeId);return t.pos.x=i.x-this.dragging.dx,t.pos.y=i.y-this.dragging.dy,null==(e=this.hooks)||e.emit("node:move",t),void this.render()}this.connecting&&(this.connecting.x=s.x,this.connecting.y=s.y,this.render());const o=this._findPortAtWorld(i.x,i.y);!o||"out"!==o.dir&&"in"!==o.dir?this._setCursor("default"):this._setCursor("grabbing")}_onUp(t){this._posScreen(t);const e=this._posWorld(t);if(this.panning)this.panning=null;else{if(this.connecting){const t=this.connecting,s=this._findPortAtWorld(e.x,e.y);s&&"in"===s.dir&&this.graph.addEdge(t.fromNode,t.fromPort,s.node.id,s.port.id),this.connecting=null,this.render()}this.dragging=null}}render(){const t=this.connecting?(()=>{const t=this._portAnchorScreen(this.connecting.fromNode,this.connecting.fromPort),e={x:this.connecting.x,y:this.connecting.y};return{x1:t.x,y1:t.y,x2:e.x,y2:e.y}})():null;this.renderer.draw(this.graph,{selection:this.selection,tempEdge:t})}_portAnchorScreen(t,e){const s=this.graph.nodes.get(t),i=s.outputs.findIndex(t=>t.id===e),o=h(s,0,i,"out");return this.renderer.worldToScreen(o.x,o.y+7)}}function c(t,e,s){return e>=t.x&&e<=t.x+t.w&&s>=t.y&&s<=t.y+t.h}class u{constructor({graph:t,registry:e,hooks:s,cyclesPerFrame:i=1}){this.graph=t,this.registry=e,this.hooks=s,this.running=!1,this._raf=null,this._last=0,this.cyclesPerFrame=Math.max(1,0|i)}step(t=1,e=0){var s;const i=Math.max(1,0|t);for(let n=0;n<i;n++){for(const t of this.graph.nodes.values()){const i=this.registry.types.get(t.type);if(null==i?void 0:i.onExecute)try{i.onExecute(t,{dt:e,graph:this.graph,getInput:e=>{const s=t.inputs.find(t=>t.name===e)||t.inputs[0];return s?this.graph.getInput(t.id,s.id):void 0},setOutput:(e,s)=>{const i=t.outputs.find(t=>t.name===e)||t.outputs[0];i&&this.graph.setOutput(t.id,i.id,s)}})}catch(o){null==(s=this.hooks)||s.emit("error",o)}}this.graph.swapBuffers()}}start(){if(this.running)return;this.running=!0;const t=e=>{if(!this.running)return;const s=this._last?(e-this._last)/1e3:0;this._last=e,this.step(this.cyclesPerFrame,s),this._raf=requestAnimationFrame(t)};this._raf=requestAnimationFrame(t)}stop(){this.running=!1,this._raf&&cancelAnimationFrame(this._raf),this._raf=null,this._last=0}}t.createGraphEditor=function(t,{theme:s,hooks:i,autorun:o=!0}={}){const r=i??function(t){const e=Object.fromEntries(t.map(t=>[t,new Set]));return{on:(t,s)=>(e[t].add(s),()=>e[t].delete(s)),async emit(t,...s){for(const i of e[t])await i(...s)}}}(["node:create","node:move","edge:create","edge:delete","graph:serialize","error"]),h=new e,a=new n({hooks:r,registry:h}),c=new d(t,{theme:s,registry:h}),f=new l({graph:a,renderer:c,hooks:r}),g=new u({graph:a,registry:h,hooks:r});h.register("core/Note",{title:"Note",size:{w:180,h:80},inputs:[{name:"in",datatype:"any"}],outputs:[{name:"out",datatype:"any"}],onCreate(t){t.state.text="hello"},onExecute(t,{dt:e,getInput:s,setOutput:i}){i("out",(s("in")??t.state.text??"").toString().toUpperCase()+` · ${Math.floor(performance.now()/1e3%100)}`)},onDraw(t,{ctx:e,theme:s}){const{x:i,y:o}=t.pos,{width:n}=t.size;e.fillStyle=s.text,e.font="11px system-ui",e.fillText(t.state.text??"hello",i+8,o+40)}}),c.resize(t.clientWidth,t.clientHeight),f.render();const p=new ResizeObserver(()=>{c.resize(t.clientWidth,t.clientHeight),f.render()});p.observe(t);const y={graph:a,renderer:c,controller:f,hooks:r,registry:h,runner:g,addNode:(...t)=>a.addNode(...t),toJSON:()=>a.toJSON(),fromJSON:t=>n.fromJSON(t,{hooks:r,registry:h}),resize:(t,e)=>c.resize(t,e),render:()=>f.render(),start:()=>g.start(),stop:()=>g.stop(),destroy:()=>{g.stop(),p.disconnect()}};return o&&g.start(),y},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=free-node.umd.js.map
