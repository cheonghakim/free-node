!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).FreeNode={})}(this,function(t){"use strict";var e=Object.defineProperty,s=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);class i{constructor(){this.types=new Map}register(t,e){if(this.types.has(t))throw new Error(`Node type exists: ${t}`);this.types.set(t,e)}unregister(t){if(this.types.has(t))throw new Error(`Node type exists: ${t}`);this.types.delete(t)}removeAll(){this.types.clear(),this.types=new Map}createInstance(t){const e=this.types.get(t);if(!e)throw new Error(`Unknown node type: ${t}`);return e}}function n(){const t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},e=t.crypto||t.msCrypto;if(e&&"function"==typeof e.randomUUID)return e.randomUUID();if(e&&"function"==typeof e.getRandomValues){const t=new Uint8Array(16);e.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128;const s=Array.from(t,t=>t.toString(16).padStart(2,"0"));return s.slice(0,4).join("")+"-"+s.slice(4,6).join("")+"-"+s.slice(6,8).join("")+"-"+s.slice(8,10).join("")+"-"+s.slice(10,16).join("")}try{const t=Function('return typeof require === "function" ? require : null')();if(t){const e=t("crypto");if("function"==typeof e.randomUUID)return e.randomUUID();const s=e.randomBytes(16);s[6]=15&s[6]|64,s[8]=63&s[8]|128;const i=Array.from(s,t=>t.toString(16).padStart(2,"0"));return i.slice(0,4).join("")+"-"+i.slice(4,6).join("")+"-"+i.slice(6,8).join("")+"-"+i.slice(8,10).join("")+"-"+i.slice(10,16).join("")}}catch{}const s=new Uint8Array(16);for(let n=0;n<16;n++)s[n]=Math.floor(256*Math.random());s[6]=15&s[6]|64,s[8]=63&s[8]|128;const i=Array.from(s,t=>t.toString(16).padStart(2,"0"));return i.slice(0,4).join("")+"-"+i.slice(4,6).join("")+"-"+i.slice(6,8).join("")+"-"+i.slice(8,10).join("")+"-"+i.slice(10,16).join("")}class o{constructor({id:t,type:e,title:s,x:i=0,y:o=0,width:r=160,height:h=60}){this.id=t??n(),this.type=e,this.title=s??e,this.pos={x:i,y:o},this.size={width:r,height:h},this.inputs=[],this.outputs=[],this.state={}}addInput(t,e="any"){const s={id:n(),name:t,datatype:e,dir:"in"};return this.inputs.push(s),s}addOutput(t,e="any"){const s={id:n(),name:t,datatype:e,dir:"out"};return this.outputs.push(s),s}}class r{constructor({id:t,fromNode:e,fromPort:s,toNode:i,toPort:o}){this.id=t??n(),this.fromNode=e,this.fromPort=s,this.toNode=i,this.toPort=o}}class h{constructor({hooks:t,registry:e}){this.nodes=new Map,this.edges=new Map,this.hooks=t,this.registry=e,this._valuesA=new Map,this._valuesB=new Map,this._useAasCurrent=!0}getNodeById(t){for(let[e,s]of this.nodes.entries())if(t===e)return s;return null}addNode(t,e={}){var s,i,n,r;const h=this.registry.types.get(t);if(!h)throw new Error(`Unknown node type: ${t}`);const d=new o({type:t,title:h.title,width:null==(s=h.size)?void 0:s.w,height:null==(i=h.size)?void 0:i.h,...e});for(const o of h.inputs||[])d.addInput(o.name,o.datatype);for(const o of h.outputs||[])d.addOutput(o.name,o.datatype);return null==(n=h.onCreate)||n.call(h,d),this.nodes.set(d.id,d),null==(r=this.hooks)||r.emit("node:create",d),d}removeNode(t){for(const[e,s]of this.edges)s.fromNode!==t&&s.toNode!==t||this.edges.delete(e);this.nodes.delete(t)}addEdge(t,e,s,i){var n;const o=new r({fromNode:t,fromPort:e,toNode:s,toPort:i});return this.edges.set(o.id,o),null==(n=this.hooks)||n.emit("edge:create",o),o}clear(){var t,e;null==(t=this.nodes)||t.clear(),null==(e=this.edges)||e.clear(),this.nodes=new Map,this.edges=new Map}_curBuf(){return this._useAasCurrent?this._valuesA:this._valuesB}_nextBuf(){return this._useAasCurrent?this._valuesB:this._valuesA}swapBuffers(){this._useAasCurrent=!this._useAasCurrent,this._nextBuf().clear()}setOutput(t,e,s){this._nextBuf().set(`${t}:${e}`,s)}getInput(t,e){for(const s of this.edges.values())if(s.toNode===t&&s.toPort===e)return this._curBuf().get(`${s.fromNode}:${s.fromPort}`)}toJSON(){var t;const e={nodes:[...this.nodes.values()].map(t=>({id:t.id,type:t.type,title:t.title,x:t.pos.x,y:t.pos.y,w:t.size.width,h:t.size.height,inputs:t.inputs,outputs:t.outputs,state:t.state})),edges:[...this.edges.values()]};return null==(t=this.hooks)||t.emit("graph:serialize",e),e}static fromJSON(t,{hooks:e,registry:s}){const i=new h({hooks:e,registry:s});for(const n of t.nodes){const t=new o({id:n.id,type:n.type,title:n.title,x:n.x,y:n.y,width:n.w,height:n.h});t.inputs=n.inputs,t.outputs=n.outputs,t.state=n.state||{},i.nodes.set(t.id,t)}for(const n of t.edges)i.edges.set(n.id,new r(n));return i}}function d(t,e,s){const{x:i,y:n}=t.pos,{width:o,height:r}=t.size;return e>=i&&e<=i+o&&s>=n&&s<=n+r}function a(t,e,s,i){const n=t.pos.y+28+20*s;return"in"===i?{x:t.pos.x-8,y:n,w:8,h:14}:"out"===i?{x:t.pos.x+t.size.width,y:n,w:8,h:14}:void 0}const l=class t{constructor(t,{theme:e={},registry:s,edgeStyle:i="orthogonal"}={}){this.canvas=t,this.ctx=t.getContext("2d"),this.registry=s,this.scale=1,this.minScale=.25,this.maxScale=3,this.offsetX=0,this.offsetY=0,this.edgeStyle=i,this.theme=Object.assign({bg:"#141417",grid:"#25252a",node:"#1e1e24",title:"#2a2a31",text:"#e9e9ef",port:"#8aa1ff",edge:"#7f8cff"},e)}setEdgeStyle(t){this.edgeStyle="line"===t||"orthogonal"===t?t:"bezier"}setRegistry(t){this.registry=t}resize(t,e){this.canvas.width=t,this.canvas.height=e}setTransform({scale:t=this.scale,offsetX:e=this.offsetX,offsetY:s=this.offsetY}={}){this.scale=Math.min(this.maxScale,Math.max(this.minScale,t)),this.offsetX=e,this.offsetY=s}panBy(t,e){this.offsetX+=t,this.offsetY+=e}zoomAt(t,e,s){const i=this.scale,n=Math.min(this.maxScale,Math.max(this.minScale,i*t));if(n===i)return;const o=(e-this.offsetX)/i,r=(s-this.offsetY)/i;this.offsetX=e-o*n,this.offsetY=s-r*n,this.scale=n}screenToWorld(t,e){return{x:(t-this.offsetX)/this.scale,y:(e-this.offsetY)/this.scale}}worldToScreen(t,e){return{x:t*this.scale+this.offsetX,y:e*this.scale+this.offsetY}}_applyTransform(){const{ctx:t}=this;t.setTransform(this.scale,0,0,this.scale,this.offsetX,this.offsetY)}_resetTransform(){this.ctx.setTransform(1,0,0,1,0,0)}_drawArrowhead(t,e,s,i,n=10){const{ctx:o}=this,r=n/this.scale,h=Math.atan2(i-e,s-t);o.beginPath(),o.moveTo(s,i),o.lineTo(s-r*Math.cos(h-Math.PI/6),i-r*Math.sin(h-Math.PI/6)),o.lineTo(s-r*Math.cos(h+Math.PI/6),i-r*Math.sin(h+Math.PI/6)),o.closePath(),o.fill()}_drawScreenText(t,e,s,{fontPx:i=12,color:n=this.theme.text,align:o="left",baseline:r="alphabetic",dpr:h=1}={}){const{ctx:d}=this,{x:a,y:l}=this.worldToScreen(e,s);d.save(),this._resetTransform();const c=Math.round(a)+.5,u=Math.round(l)+.5;d.font=i*this.scale+"px system-ui",d.fillStyle=n,d.textAlign=o,d.textBaseline=r,d.fillText(t,c,u),d.restore()}drawGrid(){const{ctx:t,canvas:e,theme:s,scale:i,offsetX:n,offsetY:o}=this;this._resetTransform(),t.fillStyle=s.bg,t.fillRect(0,0,e.width,e.height),this._applyTransform(),t.strokeStyle=s.grid,t.lineWidth=1/i;const r=20,h=-n/i,d=-o/i,a=(e.width-n)/i,l=(e.height-o)/i,c=Math.floor(h/r)*r,u=Math.floor(d/r)*r;t.beginPath();for(let f=c;f<=a;f+=r)t.moveTo(f,d),t.lineTo(f,l);for(let f=u;f<=l;f+=r)t.moveTo(h,f),t.lineTo(a,f);t.stroke(),this._resetTransform()}draw(e,{selection:s=new Set,tempEdge:i=null,running:n=!1,time:o=performance.now(),dt:r=0}={}){var h,d;this.drawGrid();const{ctx:a,theme:l}=this;if(this._applyTransform(),a.save(),n){const e=o/1e3*120/this.scale%t.FONT_SIZE;a.setLineDash([6/this.scale,6/this.scale]),a.lineDashOffset=-e}else a.setLineDash([]),a.lineDashOffset=0;a.strokeStyle=l.edge,a.lineWidth=2*this.scale;for(const t of e.edges.values())this._drawEdge(e,t);if(i){const t=this.screenToWorld(i.x1,i.y1),e=this.screenToWorld(i.x2,i.y2),s=this.ctx.getLineDash();this.ctx.setLineDash([6/this.scale,6/this.scale]);let n=null;if("line"===this.edgeStyle?(this._drawLine(t.x,t.y,e.x,e.y),n=[{x:t.x,y:t.y},{x:e.x,y:e.y}]):"orthogonal"===this.edgeStyle?n=this._drawOrthogonal(t.x,t.y,e.x,e.y):(this._drawCurve(t.x,t.y,e.x,e.y),n=[{x:t.x,y:t.y},{x:e.x,y:e.y}]),this.ctx.setLineDash(s),n&&n.length>=2){const t=n[n.length-2],e=n[n.length-1];this.ctx.fillStyle=this.theme.edge,this.ctx.strokeStyle=this.theme.edge,this._drawArrowhead(t.x,t.y,e.x,e.y,12)}}a.restore();for(const t of e.nodes.values()){const e=s.has(t.id);this._drawNode(t,e);const i=null==(d=null==(h=this.registry)?void 0:h.types)?void 0:d.get(t.type);(null==i?void 0:i.onDraw)&&i.onDraw(t,{ctx:a,theme:l})}this._resetTransform()}_drawNode(e,s){const{ctx:i,theme:n}=this,{x:o,y:r}=e.pos,{width:h,height:d}=e.size;i.fillStyle=n.node,i.strokeStyle=s?"#6cf":"#333",i.lineWidth=(s?2:1.2)/this.scale,u(i,o,r,h,d,8),i.fill(),i.stroke(),i.fillStyle=n.title,u(i,o,r,h,24,{tl:8,tr:8,br:0,bl:0}),i.fill(),this._drawScreenText(e.title,o+8,r+t.FONT_SIZE,{fontPx:t.FONT_SIZE,color:n.text,baseline:"middle",align:"left"}),i.fillStyle=n.port,e.inputs.forEach((t,s)=>{const n=a(e,0,s,"in");i.fillRect(n.x,n.y,n.w,n.h)}),e.outputs.forEach((t,s)=>{const n=a(e,0,s,"out");i.fillRect(n.x,n.y,n.w,n.h)})}_drawEdge(t,e){const s=t.nodes.get(e.fromNode),i=t.nodes.get(e.toNode);if(!s||!i)return;const n=s.outputs.findIndex(t=>t.id===e.fromPort),o=i.inputs.findIndex(t=>t.id===e.toPort),r=a(s,0,n,"out"),h=a(i,0,o,"in"),d=r.x,l=r.y+7,c=h.x,u=h.y+7;"line"===this.edgeStyle?this._drawLine(d,l,c,u):"orthogonal"===this.edgeStyle?this._drawOrthogonal(d,l,c,u):this._drawCurve(d,l,c,u)}_drawLine(t,e,s,i){const{ctx:n}=this;n.beginPath(),n.moveTo(t,e),n.lineTo(s,i),n.stroke()}_drawPolyline(t){const{ctx:e}=this;e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)e.lineTo(t[s].x,t[s].y);e.stroke()}_drawOrthogonal(t,e,s,i){const n=(t+s)/2;let o;o=[{x:t,y:e},{x:n,y:e},{x:n,y:i},{x:s,y:i}];const{ctx:r}=this,h=r.lineJoin,d=r.lineCap;return r.lineJoin="round",r.lineCap="round",this._drawPolyline(o),r.lineJoin=h,r.lineCap=d,o}_drawCurve(t,e,s,i){const{ctx:n}=this,o=Math.max(40,.4*Math.abs(s-t));n.beginPath(),n.moveTo(t,e),n.bezierCurveTo(t+o,e,s-o,i,s,i),n.stroke()}};s(l,"FONT_SIZE",12);let c=l;function u(t,e,s,i,n,o=6){"number"==typeof o&&(o={tl:o,tr:o,br:o,bl:o}),t.beginPath(),t.moveTo(e+o.tl,s),t.lineTo(e+i-o.tr,s),t.quadraticCurveTo(e+i,s,e+i,s+o.tr),t.lineTo(e+i,s+n-o.br),t.quadraticCurveTo(e+i,s+n,e+i-o.br,s+n),t.lineTo(e+o.bl,s+n),t.quadraticCurveTo(e,s+n,e,s+n-o.bl),t.lineTo(e,s+o.tl),t.quadraticCurveTo(e,s,e+o.tl,s),t.closePath()}function f(t,e,s,i,n){for(const[o,r]of t.edges)if(r.fromNode===e&&r.fromPort===s&&r.toNode===i&&r.toPort===n)return o;return null}class g{constructor(){this.undoStack=[],this.redoStack=[]}exec(t){t.do(),this.undoStack.push(t),this.redoStack.length=0}undo(){const t=this.undoStack.pop();t&&(t.undo(),this.redoStack.push(t))}redo(){const t=this.redoStack.pop();t&&(t.do(),this.undoStack.push(t))}}const p=class t{constructor({graph:t,renderer:e,hooks:s}){this.graph=t,this.renderer=e,this.hooks=s,this.stack=new g,this.selection=new Set,this.dragging=null,this.connecting=null,this.panning=null,this.resizing=null,this._cursor="default",this._onKeyPressEvt=this._onKeyPress.bind(this),this._onDownEvt=this._onDown.bind(this),this._onWheelEvt=this._onWheel.bind(this),this._onMoveEvt=this._onMove.bind(this),this._onUpEvt=this._onUp.bind(this),this._bindEvents()}destructor(){const t=this.renderer.canvas;t.removeEventListener("mousedown",this._onDownEvt),t.removeEventListener("wheel",this._onWheelEvt,{passive:!1}),window.removeEventListener("mousemove",this._onMoveEvt),window.removeEventListener("mouseup",this._onUpEvt),window.removeEventListener("keydown",this._onKeyPressEvt)}_bindEvents(){const t=this.renderer.canvas;t.addEventListener("mousedown",this._onDownEvt),t.addEventListener("wheel",this._onWheelEvt,{passive:!1}),window.addEventListener("mousemove",this._onMoveEvt),window.addEventListener("mouseup",this._onUpEvt),window.addEventListener("keydown",this._onKeyPressEvt)}_onKeyPress(t){return(t.ctrlKey||t.metaKey)&&"z"===t.key.toLowerCase()?(t.preventDefault(),t.shiftKey?this.stack.redo():this.stack.undo(),void this.render()):(t.ctrlKey||t.metaKey)&&"y"===t.key.toLowerCase()?(t.preventDefault(),this.stack.redo(),void this.render()):void("Delete"===t.key&&([...this.selection].forEach(t=>{const e=this.graph.getNodeById(t);this.stack.exec(function(t,e){let s=null,i=[];return{do(){s=e,i=t.edges?[...t.edges.values()].filter(t=>(console.log(t),t.fromNode===e.id||t.toNode===e.id)):[];for(const e of i)t.edges.delete(e.id);t.nodes.delete(e.id)},undo(){s&&t.nodes.set(s.id,s);for(const e of i)t.edges.set(e.id,e)}}}(this.graph,e)),this.graph.removeNode(t)}),this.render()))}_setCursor(t){this._cursor!==t&&(this._cursor=t,this.renderer.canvas.style.cursor=t)}_posScreen(t){const e=this.renderer.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}_posWorld(t){const e=this._posScreen(t);return this.renderer.screenToWorld(e.x,e.y)}_findNodeAtWorld(t,e){const s=[...this.graph.nodes.values()];for(let i=s.length-1;i>=0;i--){const n=s[i];if(d(n,t,e))return n}return null}_findPortAtWorld(t,e){for(const s of this.graph.nodes.values()){for(let i=0;i<s.inputs.length;i++){if(m(a(s,s.inputs[i],i,"in"),t,e))return{node:s,port:s.inputs[i],dir:"in",idx:i}}for(let i=0;i<s.outputs.length;i++){if(m(a(s,s.outputs[i],i,"out"),t,e))return{node:s,port:s.outputs[i],dir:"out",idx:i}}}return null}_onWheel(t){t.preventDefault();const{x:e,y:s}=this._posScreen(t),i=Math.pow(1.0015,-t.deltaY);this.renderer.zoomAt(i,e,s),this.render()}_findIncomingEdge(t,e){for(const[s,i]of this.graph.edges)if(i.toNode===t&&i.toPort===e)return{id:s,edge:i};return null}_resizeHandleRect(t){return{x:t.pos.x+t.size.width-10,y:t.pos.y+t.size.height-10,w:10,h:10}}_hitResizeHandle(t,e,s){const i=this._resizeHandleRect(t);return e>=i.x&&e<=i.x+i.w&&s>=i.y&&s<=i.y+i.h}_onDown(t){const e=this._posScreen(t),s=this._posWorld(t);if(1===t.button)return void(this.panning={x:e.x,y:e.y});const i=this._findPortAtWorld(s.x,s.y);if(0===t.button&&i&&"out"===i.dir){const t=a(i.node,i.port,i.idx,"out"),e=this.renderer.worldToScreen(t.x,t.y+7);return void(this.connecting={fromNode:i.node.id,fromPort:i.port.id,x:e.x,y:e.y})}if(0===t.button&&i&&"in"===i.dir){const t=this._findIncomingEdge(i.node.id,i.port.id);if(t){const{edge:e,id:s}=t,i=function(t,e){const s=t.edges.get(e);if(!s)return null;const{fromNode:i,fromPort:n,toNode:o,toPort:r}=s;return{do(){t.edges.delete(e)},undo(){t.addEdge(i,n,o,r)}}}(this.graph,s);i&&this.stack.exec(i);const n=this.graph.nodes.get(e.fromNode),o=n.outputs.findIndex(t=>t.id===e.fromPort),r=a(n,n.outputs[o],o,"out"),h=this.renderer.worldToScreen(r.x,r.y+7);return this.connecting={fromNode:e.fromNode,fromPort:e.fromPort,x:h.x,y:h.y,_removedEdge:{id:s,edge:e}},void this.render()}}const n=this._findNodeAtWorld(s.x,s.y);return 0===t.button&&n&&this._hitResizeHandle(n,s.x,s.y)?(this.resizing={nodeId:n.id,startW:n.size.width,startH:n.size.height,startX:s.x,startY:s.y},t.shiftKey||this.selection.clear(),this.selection.add(n.id),this._setCursor("se-resize"),void this.render()):0===t.button&&n?(t.shiftKey||this.selection.clear(),this.selection.add(n.id),this.dragging={nodeId:n.id,dx:s.x-n.pos.x,dy:s.y-n.pos.y,startPos:{x:n.pos.x,y:n.pos.y}},void this.render()):0===t.button?(this.selection.size&&this.selection.clear(),this.panning={x:e.x,y:e.y},void this.render()):void 0}_onMove(e){var s,i;const n=this._posScreen(e),o=this.renderer.screenToWorld(n.x,n.y);if(this.resizing){const e=this.graph.nodes.get(this.resizing.nodeId),i=o.x-this.resizing.startX,n=o.y-this.resizing.startY,r=t.MIN_NODE_WIDTH,h=t.MIN_NODE_HEIGHT;return e.size.width=Math.max(r,this.resizing.startW+i),e.size.height=Math.max(h,this.resizing.startH+n),null==(s=this.hooks)||s.emit("node:resize",e),this._setCursor("se-resize"),void this.render()}if(this.panning){const t=n.x-this.panning.x,e=n.y-this.panning.y;return this.panning={x:n.x,y:n.y},this.renderer.panBy(t,e),void this.render()}if(this.dragging){const t=this.graph.nodes.get(this.dragging.nodeId);return t.pos.x=o.x-this.dragging.dx,t.pos.y=o.y-this.dragging.dy,null==(i=this.hooks)||i.emit("node:move",t),void this.render()}this.connecting&&(this.connecting.x=n.x,this.connecting.y=n.y,this.render());const r=this._findPortAtWorld(o.x,o.y);!r||"out"!==r.dir&&"in"!==r.dir?this._setCursor("default"):this._setCursor("grabbing");const h=this._findNodeAtWorld(o.x,o.y);h&&this._hitResizeHandle(h,o.x,o.y)&&(this._setCursor("se-resize"),this.render())}_onUp(t){this._posScreen(t);const e=this._posWorld(t);if(this.panning)this.panning=null;else{if(this.connecting){const t=this.connecting,s=this._findPortAtWorld(e.x,e.y);s&&"in"===s.dir&&this.stack.exec(function(t,e,s,i,n){let o=null;return{do(){t.addEdge(e,s,i,n),o=f(t,e,s,i,n)},undo(){const r=o??f(t,e,s,i,n);null!=r&&t.edges.delete(r)}}}(this.graph,t.fromNode,t.fromPort,s.node.id,s.port.id)),this.connecting=null,this.render()}if(this.resizing){const t=this.graph.nodes.get(this.resizing.nodeId),e={w:this.resizing.startW,h:this.resizing.startH},o={w:t.size.width,h:t.size.height};e.w===o.w&&e.h===o.h||this.stack.exec((s=t,i=e,n=o,{do(){s.size.width=n.w,s.size.height=n.h},undo(){s.size.width=i.w,s.size.height=i.h}})),this.resizing=null,this._setCursor("default")}var s,i,n;if(this.dragging){const t=this.graph.nodes.get(this.dragging.nodeId),e=this.dragging.startPos,s={x:t.pos.x,y:t.pos.y};e.x===s.x&&e.y===s.y||this.stack.exec(function(t,e,s){return{do(){t.pos={...s}},undo(){t.pos={...e}}}}(t,e,s)),this.dragging=null}this.dragging=null}}render(){const t=this.renderTempEdge();this.renderer.draw(this.graph,{selection:this.selection,tempEdge:t})}renderTempEdge(){if(!this.connecting)return null;const t=this._portAnchorScreen(this.connecting.fromNode,this.connecting.fromPort);return{x1:t.x,y1:t.y,x2:this.connecting.x,y2:this.connecting.y}}_portAnchorScreen(t,e){const s=this.graph.nodes.get(t),i=s.outputs.findIndex(t=>t.id===e),n=a(s,0,i,"out");return this.renderer.worldToScreen(n.x,n.y+7)}};s(p,"MIN_NODE_WIDTH",80),s(p,"MIN_NODE_HEIGHT",60);let y=p;function m(t,e,s){return e>=t.x&&e<=t.x+t.w&&s>=t.y&&s<=t.y+t.h}class x{constructor({graph:t,registry:e,hooks:s,cyclesPerFrame:i=1}){this.graph=t,this.registry=e,this.hooks=s,this.running=!1,this._raf=null,this._last=0,this.cyclesPerFrame=Math.max(1,0|i)}isRunning(){return this.running}setCyclesPerFrame(t){this.cyclesPerFrame=Math.max(1,0|t)}step(t=1,e=0){var s,i;const n=Math.max(1,0|t);for(let r=0;r<n;r++){for(const t of this.graph.nodes.values()){const n=this.registry.types.get(t.type);if(null==n?void 0:n.onExecute)try{n.onExecute(t,{dt:e,graph:this.graph,getInput:e=>{const s=t.inputs.find(t=>t.name===e)||t.inputs[0];return s?this.graph.getInput(t.id,s.id):void 0},setOutput:(e,s)=>{const i=t.outputs.find(t=>t.name===e)||t.outputs[0];i&&this.graph.setOutput(t.id,i.id,s)}})}catch(o){null==(i=null==(s=this.hooks)?void 0:s.emit)||i.call(s,"error",o)}}this.graph.swapBuffers()}}start(){var t,e;if(this.running)return;this.running=!0,this._last=0,null==(e=null==(t=this.hooks)?void 0:t.emit)||e.call(t,"runner:start");const s=t=>{var e,i;if(!this.running)return;const n=this._last?t-this._last:0;this._last=t;const o=n/1e3;this.step(this.cyclesPerFrame,o),null==(i=null==(e=this.hooks)?void 0:e.emit)||i.call(e,"runner:tick",{time:t,dt:o,running:!0,cps:this.cyclesPerFrame}),this._raf=requestAnimationFrame(s)};this._raf=requestAnimationFrame(s)}stop(){var t,e;this.running&&(this.running=!1,this._raf&&cancelAnimationFrame(this._raf),this._raf=null,this._last=0,null==(e=null==(t=this.hooks)?void 0:t.emit)||e.call(t,"runner:stop"))}}t.createGraphEditor=function(t,{theme:e,hooks:s,autorun:n=!0}={}){const o=s??function(t){const e=Object.fromEntries(t.map(t=>[t,new Set]));return{on:(t,s)=>(e[t].add(s),()=>e[t].delete(s)),async emit(t,...s){for(const i of e[t])await i(...s)}}}(["node:create","node:move","edge:create","edge:delete","graph:serialize","error","runner:tick","runner:start","runner:stop","node:resize"]),r=new i,d=new h({hooks:o,registry:r}),a=new c(t,{theme:e,registry:r}),l=new y({graph:d,renderer:a,hooks:o}),u=new x({graph:d,registry:r,hooks:o});o.on("runner:tick",({time:t,dt:e})=>{a.draw(d,{selection:l.selection,tempEdge:l.connecting?l.renderTempEdge():null,running:!0,time:t,dt:e})}),o.on("runner:start",()=>{a.draw(d,{selection:l.selection,tempEdge:l.connecting?l.renderTempEdge():null,running:!0,time:performance.now(),dt:0})}),o.on("runner:stop",()=>{a.draw(d,{selection:l.selection,tempEdge:l.connecting?l.renderTempEdge():null,running:!1,time:performance.now(),dt:0})}),r.register("core/Note",{title:"Note",size:{w:180,h:80},inputs:[{name:"in",datatype:"any"}],outputs:[{name:"out",datatype:"any"}],onCreate(t){t.state.text="hello"},onExecute(t,{dt:e,getInput:s,setOutput:i}){i("out",(s("in")??t.state.text??"").toString().toUpperCase()+` · ${Math.floor(performance.now()/1e3%100)}`)},onDraw(t,{ctx:e,theme:s}){const{x:i,y:n}=t.pos,{width:o}=t.size}}),a.resize(t.clientWidth,t.clientHeight),l.render();const f=new ResizeObserver(()=>{a.resize(t.clientWidth,t.clientHeight),l.render()});f.observe(t);const g={graph:d,renderer:a,controller:l,hooks:o,registry:r,runner:u,addNode:(...t)=>d.addNode(...t),toJSON:()=>d.toJSON(),fromJSON:t=>h.fromJSON(t,{hooks:o,registry:r}),resize:(t,e)=>a.resize(t,e),render:()=>l.render(),start:()=>u.start(),stop:()=>u.stop(),destroy:()=>{u.stop(),f.disconnect()}};return n&&u.start(),g},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=free-node.umd.js.map
